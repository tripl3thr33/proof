<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Online Proofing App</title>
  <style>
    body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 40px 20px;
  background: #f5f7fa;
  color: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

h1 {
  font-weight: 700;
  font-size: 2.4rem;
  margin-bottom: 30px;
  color: #222;
}

canvas {
  border-radius: 50%;
  background-color: #1e1e1e;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  max-width: 100%;
  height: auto;
  touch-action: none;
  transition: box-shadow 0.3s ease;
  margin: 30px;
}

canvas:hover {
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
}

.controls {
  margin-bottom: 30px;
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
  width: 100%;
  max-width: 420px;
}

.controls input[type="file"] {
  flex-grow: 1;
  border: none;
  font-size: 1rem;
  cursor: pointer;
}

label[for="bg-color"] {
  align-self: center;
  font-weight: 600;
  margin-right: 8px;
  color: #555;
}

#bg-color {
  width: 40px;
  height: 40px;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

button {
  background: #0078d7;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 12px 20px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,120,215,0.4);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  user-select: none;
  margin: 20px 0;
}

button:hover {
  background: #005ea3;
  box-shadow: 0 6px 18px rgba(0,94,163,0.6);
}

.center-buttons {
  display: flex;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.form {
  background: white;
  padding: 25px 30px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  border-radius: 12px;
  width: 100%;
  max-width: 800px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.form p {
font-style: italic;
line-height: 1.5em;
}

.form input[type="text"],
.form input[type="email"] {
  padding: 12px 15px;
  font-size: 1rem;
  border: 1.8px solid #ddd;
  border-radius: 8px;
  transition: border-color 0.3s ease;
}

.form input[type="file"] {
  position: relative;
}

.form input[type="file"]::file-selector-button {
  width: 126px;
  color: transparent;
}

.form input[type="file"]::before {
  position: absolute;
  pointer-events: none;
  top: 10px;
  left: 16px;
  height: 20px;
  width: 20px;
  content: "";
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235c5c5c'%3E%3Cpath d='M18 15v3H6v-3H4v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2zM7 9l1.41 1.41L11 7.83V16h2V7.83l2.59 2.58L17 9l-5-5-5 5z'/%3E%3C/svg%3E");
}

.form input[type="file"]::after {
  position: absolute;
  pointer-events: none;
  top: 11px;
  left: 40px;
  color: #5c5c5c;
  content: "Upload File";
}

/* file upload button */
.form input[type="file"]::file-selector-button {
  border-radius: 4px;
  padding: 0 16px;
  height: 40px;
  cursor: pointer;
  border: 1px solid rgba(0, 0, 0, 0.16);
  background-color: white;
  box-shadow: 0px 1px 0px rgba(0, 0, 0, 0.05);
  margin-right: 16px;
  transition: background-color 200ms;
}

/* file upload button hover state */
.form input[type="file"]::file-selector-button:hover {
  background-color: #f3f4f6;
}

/* file upload button active state */
.form input[type="file"]::file-selector-button:active {
  background-color: #e5e7eb;
}


.form input[type="text"]:focus,
.form input[type="email"]:focus {
  border-color: #0078d7;
  outline: none;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
}

.form button[type="submit"] {
  margin-top: 10px;
}

.form label {
  text-align: center;
}

@media (max-width: 480px) {
  .controls {
    flex-direction: column;
    max-width: 100%;
  }
  .center-buttons {
    justify-content: center;
  }
  .form {
    padding: 20px;
  }
}

.file_upload {
  justify-content: center;
  text-align: center;
  background-color: rgba(0, 0, 0, 0.2);
}
.scale-control {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 20px 0;
  max-width: 420px;
  width: 100%;
  justify-content: center;
}

#scale-slider {
  flex-grow: 1;
  cursor: pointer;
}

#scale-value {
  min-width: 50px;
  text-align: center;
  font-weight: bold;
}

.canvas-container {
  width: 800px;
}

  </style>
</head>
<body>
  <h1>Upload Your Design</h1>
  <form class="form" id="proof-form">
      <p> Thank you for your order! To get started, please use our live proofing app to upload your logo. You’ll be able to adjust the size and position of your image to exactly how you want it printed.
	  </p>
	  <p>For the best results, make sure to upload a clear, high-resolution file. Since we print exactly what is submitted, feel free to reach out via email or message us if you’re unsure whether your image is suitable for printing.  We’re happy to help! 
	  </p>
	  <br />
    <input type="text" id="name" name="name" placeholder="Your Name" required /><br />
	<input type="email" id="email" name="email" placeholder="Your Email" required /><br />
    <input type="text" id="orderNumber" name="orderNumber" placeholder="Order Number" required /><br />
	<p> Upload your file below using any of these accepted file formats: .jpg, .png, .svg
	<b><br />For other file formats, please email us at support@adeptsigns.com with your file and order number and we will have a digital proof made for you within 1-2 business days.</b>
	</p>
	<input type="file" id="file-input" />
  </form>
  
  <div class="canvas-container">
	<canvas id="canvas" width="800" height="800"></canvas>
  </div>
  <div class="scale-control">
  <label for="scale-slider">Adjust Image Size:</label>
  <input type="range" id="scale-slider" min="0.1" max="3" step="0.01" value="1" />
  <span id="scale-value">100%</span>
  </div>
  	<div class="controls">
		<label for="bg-color">Background Color:</label>
		<input type="color" id="bg-color" value="#000000" />
    <div class="center-buttons">
      <button type="button" id="center-vertical">Center Vertically</button>
      <button type="button" id="center-horizontal">Center Horizontally</button>
    </div>
  </div>
  <div class="form">
	<p>Please review final artwork carefully.  Your approval will indicate acceptance of materials including responsibility for errors, omissions and legal and ethical compliance. If we are printing this project and if a rerun is necessary due to overlooked error(s) in this final document, customer assumes responsibility and charges. No printing will be started until payment and approval of this design proof is received.</p>
	<p>Proof approvals will be made before 3pm PST will be added to the production queue starting the next business day.  Any proof approvals made after 3pm PST will be accepted the following business day and will start the production timeline the following business day.  Production timelines differ from product to product and do not include transit shipping times.  Please refer to your product listing page for the production timeline. Estimated shipping timelines are estimates.  Factors such as weather delays, shipping delays, or other unforseen circumstances outside of our control may affect delivery dates.  For rush shipping, please contact us via email or messages prior to proof approval to make sure we can deliver it to you in time.</p>
  </div>

  <button onclick="submitForm()" id="submit-btn" type="submit">
  <span id="button-text">Approve & Submit</span>
  <span id="loading-spinner" style="display: none; margin-left: 8px;">
    ⏳
  </span>
  </button>

  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('file-input');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const bgColorInput = document.getElementById('bg-color');
      const proofForm = document.getElementById('proof-form');
      const centerVerticalBtn = document.getElementById('center-vertical');
      const centerHorizontalBtn = document.getElementById('center-horizontal');
      const scaleSlider = document.getElementById('scale-slider');
	  const scaleValueDisplay = document.getElementById('scale-value');


      let uploadedImg = new Image();
      let imgLoaded = false;
      let scale = 1;
      let posX = canvas.width / 2;
      let posY = canvas.height / 2;
      let imgWidth, imgHeight;

      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;

      let lastTouchX = 0;
      let lastTouchY = 0;
      let pinchStartDist = 0;

      function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = bgColorInput.value;
        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, Math.PI * 2);
        ctx.fill();
        if (imgLoaded) {
          ctx.save();
          ctx.beginPath();
          ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, Math.PI * 2);
          ctx.clip();
          ctx.drawImage(
            uploadedImg,
            posX - (imgWidth * scale) / 2,
            posY - (imgHeight * scale) / 2,
            imgWidth * scale,
            imgHeight * scale
          );
          ctx.restore();
        }
      }

	  // Update scale when slider value changes
	  scaleSlider.addEventListener('input', () => {
	    scale = parseFloat(scaleSlider.value);
	    scaleValueDisplay.textContent = `${Math.round(scale * 100)}%`;
	    drawCanvas();
	  });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        uploadedImg = new Image();
        uploadedImg.onload = () => {
          if (uploadedImg.width < 2000 || uploadedImg.height < 2000) {
            alert('Warning: Image may not be high enough resolution for best print quality.');
          }
          imgWidth = uploadedImg.width;
          imgHeight = uploadedImg.height;
          scale = Math.min(canvas.width / imgWidth, canvas.height / imgHeight);
          posX = canvas.width / 2;
          posY = canvas.height / 2;
          imgLoaded = true;
          drawCanvas();
		  window.uploadedImg = uploadedImg;
		  window.imgLoaded = imgLoaded;
		  window.posX = posX;
		  window.posY = posY;
		  window.imgWidth = imgWidth;
		  window.imgHeight = imgHeight;
        };
        uploadedImg.src = url;
      });

      bgColorInput.addEventListener('input', drawCanvas);

      canvas.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragStartX = e.offsetX;
        dragStartY = e.offsetY;
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.offsetX - dragStartX;
        const dy = e.offsetY - dragStartY;
        posX += dx;
        posY += dy;
        dragStartX = e.offsetX;
        dragStartY = e.offsetY;
        drawCanvas();
      });

      window.addEventListener('mouseup', () => {
        isDragging = false;
      });

	  canvas.addEventListener('wheel', (e) => {
		if (!imgLoaded || window.innerWidth < 768) return;
		  e.preventDefault();
		  const delta = e.deltaY < 0 ? 1.05 : 0.95;
		  scale *= delta;
		  scale = Math.max(0.1, Math.min(scale, 3)); // Clamp scale between 0.1 and 3
		  scaleSlider.value = scale.toFixed(2);
		  scaleValueDisplay.textContent = `${Math.round(scale * 100)}%`;
		  drawCanvas();
		});

      canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          lastTouchX = e.touches[0].clientX;
          lastTouchY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          pinchStartDist = Math.sqrt(dx * dx + dy * dy);
        }
      });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const dx = touch.clientX - lastTouchX;
          const dy = touch.clientY - lastTouchY;
          posX += dx;
          posY += dy;
          lastTouchX = touch.clientX;
          lastTouchY = touch.clientY;
          drawCanvas();
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const pinchEndDist = Math.sqrt(dx * dx + dy * dy);
          if (pinchStartDist > 0) {
            const pinchScale = pinchEndDist / pinchStartDist;
            if (!isNaN(pinchScale) && isFinite(pinchScale)) {
              scale *= pinchScale;
              pinchStartDist = pinchEndDist;
              drawCanvas();
            }
          }
        }
      }, { passive: false });

      centerVerticalBtn.addEventListener('click', () => {
        if (!imgLoaded) return;
        posY = canvas.height / 2;
        drawCanvas();
      });

      centerHorizontalBtn.addEventListener('click', () => {
        if (!imgLoaded) return;
        posX = canvas.width / 2;
        drawCanvas();
      });
    });

async function submitForm() {
  const submitBtn = document.getElementById('submit-btn');
  const buttonText = document.getElementById('button-text');
  const spinner = document.getElementById('loading-spinner');

  submitBtn.disabled = true;
  buttonText.textContent = "Submitting...";
  spinner.style.display = 'inline-block';
  const originalCanvas = document.getElementById('canvas');
  if (!originalCanvas) {
    alert("Canvas element not found!");
    return;
  }

  const name = document.getElementById('name')?.value || '';
  const email = document.getElementById('email')?.value || '';
  const orderNumber = document.getElementById('orderNumber')?.value || '';
  const bgColor = document.getElementById('bg-color')?.value || '#000000';

  // Reference to your image and settings from global scope
  const scaleSlider = document.getElementById('scale-slider');
  const scale = parseFloat(scaleSlider?.value || '1');
  const uploadedImg = window.uploadedImg;
  const imgLoaded = window.imgLoaded;
  const posX = window.posX;
  const posY = window.posY;
  const imgWidth = window.imgWidth;
  const imgHeight = window.imgHeight;

  if (!imgLoaded) {
    alert("Please upload an image before submitting.");
    return;
  }

  // 1. Create high-res canvas
  const highResCanvas = document.createElement('canvas');
  highResCanvas.width = 4000;
  highResCanvas.height = 4000;
  const ctx = highResCanvas.getContext('2d');

  // 2. Fill circular background
  ctx.fillStyle = bgColor;
  ctx.beginPath();
  ctx.arc(2000, 2000, 2000, 0, Math.PI * 2);
  ctx.fill();

  // 3. Clip to circle
  ctx.save();
  ctx.beginPath();
  ctx.arc(2000, 2000, 2000, 0, Math.PI * 2);
  ctx.clip();

  // 4. Calculate scale/position based on original canvas ratio
  const scaleFactor = 4000 / originalCanvas.width;
  const scaledImgWidth = imgWidth * scale * scaleFactor;
  const scaledImgHeight = imgHeight * scale * scaleFactor;
  const offsetX = (posX * scaleFactor) - (scaledImgWidth / 2);
  const offsetY = (posY * scaleFactor) - (scaledImgHeight / 2);

  ctx.drawImage(uploadedImg, offsetX, offsetY, scaledImgWidth, scaledImgHeight);
  ctx.restore();

  // 5. Convert to base64
  const imageDataURL = highResCanvas.toDataURL('image/png');
  const base64Image = imageDataURL.split(',')[1];

  // 6. Prepare FormData
  const formData = new FormData();
  formData.append('file', base64Image);
  formData.append('filename', `${orderNumber}_${name}_proof.png`);
  formData.append('mimeType', 'image/png');
  formData.append('name', name);
  formData.append('email', email);
  formData.append('orderNumber', orderNumber);

  const scriptURL = 'https://script.google.com/macros/s/AKfycbwXXwrO7dThW-z6uKIJdyq5J6P2bRhyc6_eIregd2EQRDhw6IzDgOfMqhdKXRMce3E/exec';

  try {
    const response = await fetch(scriptURL, {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    if (result.success) {
      alert("✅ Upload successful!\n" + result.url);
    } else {
      alert("❌ Upload failed: " + result.error);
    }
  } catch (error) {
    alert("❌ Network error: " + error.message);
  } finally {
    // Re-enable button and hide spinner
    submitBtn.disabled = false;
    buttonText.textContent = "Approve & Submit";
    spinner.style.display = 'none';
  }
}
  </script>
</body>
</html>
